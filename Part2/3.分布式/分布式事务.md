## 两阶段提交协议

- prepare阶段：TM给各个库发送prepare，执行sql，不要提交

  各个库成功了就返回成功的消息，失败就返回失败

- commit阶段

  - 若prepare阶段某个库给TM返回失败，或者超时未响应，TM通知所有库回滚

  - 若各个库都返回成功，TM就通知各个库提交

#### 带来的问题

- 同步阻塞：prepare阶段的操作会占用资源，别人要访问就会阻塞住
- 单点故障：TM是单点
- 事务状态丢失：就算TM做双机热备，一个挂了另一个顶上，但是新的TM不知道分布式事务当前的状态，即哪个库接收过commit哪个没接收
- 脑裂问题：commit阶段中如果发生脑裂，可能会导致有些库收到commit，有些没收到







## 三阶段提交协议

- CanCommit阶段：TM给各个库发送CanCommit，检查网络环境等情况，不执行SQL

- PreCommit阶段

  - 若各个库CanCommit阶段都返回成功，TM就给各个库发送PreCommit，相当于2PC的prepare阶段，执行SQL但不提交

  - 若CanCommit阶段有返回失败的，TM就通知回滚

- DoCommit阶段

  - 若各个库PreCommit阶段都返回成功，TM就给各个库发送DoCommit提交事务

  - 若PreCommit阶段有返回失败的，或超时的，TM就通知回滚

#### 超时机制

若一个库收到了PreCommit而且返回成功，等一会超时时间到了还没收到TM发送的DoCommit或abort，直接判定TM出故障，自动commit提交事务

这样解决了TM单点问题，减轻资源阻塞问题







## TCC







## 本地消息表







## 可靠消息最终一致性方案







## 最大努力通知方案

看到44