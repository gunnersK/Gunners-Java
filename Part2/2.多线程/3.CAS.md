## CAS原理

**C**ompare **A**nd **S**et

乐观锁，也叫无锁优化

修改值之前把原来的值保存在E，然后修改值为V，再比较当前值N和E是否相同，相同就更新为新值V，不相同则继续比较，直到相同

1. **取值**：先获取值
2. **比较**：再去跟当前值比较
3. **修改**：值没变，就设新值
4. 值变了，重复123步

2和3就是CAS过程，会在硬件层面保证其原子性

**硬件层面怎么保证的了解下**







## AtomicXXX类

atomic都是用CAS保证线程安全，内部使用Unsafe类







## ABA问题

ABA问题：原来的值是0，在当前线程更新为新值之前，别的线程把0改为2，又改回0，这时的0已经不是原来的0了，这就是ABA问题

解决方法：多保存一个版本号，每次修改之后都把版本号加1，比较时连版本号一块比较







## LongAdder

把一个数分成好几段，分段锁，算完加在一起，用的是forkjoin