## 含义

- Redis读写都在内存，一旦进程退出会导致数据丢失，所以可以使用持久化的方式解决重启后数据恢复的问题







## 策略

#### RDB（快照方式：Redis Database）

每隔一定时间把当前进程数据生成快照保存到硬盘，分为手动触发和自动触发两种



#### AOF（文件追加方式：Append Only File）

记录所有的操作命令，并以文本的形式追加到文件中



#### 混合持久化

Redis 4.0 之后新增的，结合了 RDB 和 AOF 的优点，在写入的时候，先把当前的数据以 RDB 的形式写入文件的开头，再将后续的操作命令以 AOF 的格式存入文件，这样既能保证 Redis 重启时的速度，又能减低数据丢失的风险。







## AOF

#### 定义

以追加的形式将每条写入命令写入日志文件，在Redis重启时，可通过回放AOP日志中的**写入指令**恢复数据集

先写入OS Cache，再调用系统fsync函数写入AOF文件

**看到这05，下一步看rewrite**



#### Rewrite机制

`详细了解`

当内存中的数据被LRU淘汰，AOF文件到一定大小时，会将命令写入新的文件



看到4、AOF持久化机制的优点 



## RDB（默认启动）

#### 定义

每隔一定时间，将那个时刻的内存快照，以**二进制**数据的形式全量写进磁盘文件

而且每次都写进新文件，即每个文件都代表了某个时刻Redis中的完整数据



#### 优点

- 性能影响小：只需fork子进程来进行磁盘IO
- 恢复速度快：重启可用RDB文件来恢复数据（基于二进制数据）
- 适合做冷备份



#### 缺点

- 丢失数据：由于是每隔一定时间才保存，所以宕机时相比AOP方式会丢失相对较多的数据
- 暂停服务：fork子进程生成文件时，若数据特别大，可能会导致暂停数毫秒 至 数秒



#### 方式

有两种：手动触发和自动触发

- 手动触发

	- ```save```命令：阻塞主线程，必须等到RDB持久化完成之后，才会相应客户端的命令，所以**线上环境不建议使用**
	- ```bgsave```命令：Redis进程首先执行fork操作创建子进程，RDB持久化过程由子进程负责，完成后自动结束。阻塞只发生在fork阶段，一般时间很短，基本不会发生阻塞
	
- 自动触发

  - ```save m n```：表示m秒内有n个key修改时，自动触发`bgsave`命令

  - 在redis.conf配置文件配置

    ```shell
    save 900 1
    save 300 10
    save 60 10000
    ```