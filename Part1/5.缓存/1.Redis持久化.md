## 含义

Redis读写都在内存，一旦进程退出会导致数据丢失，所以可以使用持久化的方式解决重启后数据恢复的问题







## 策略

#### RDB（快照方式：Redis Database）

每隔一定时间把当前进程数据生成快照保存到硬盘，分为手动触发和自动触发两种



#### AOF（文件追加方式：Append Only File）

记录所有的操作命令，并以文本的形式追加到文件中



#### 混合持久化

Redis 4.0 之后新增的，结合了 RDB 和 AOF 的优点，在写入的时候，先把当前的数据以 RDB 的形式写入文件的开头，再将后续的操作命令以 AOF 的格式存入文件，这样既能保证 Redis 重启时的速度，又能减低数据丢失的风险。







## AOF（默认关闭）

#### 定义

以追加的形式将每条写入命令写入日志文件，在Redis重启时，可通过回放AOP日志中的**写入指令**恢复数据集

先写入OS Cache，再每秒调用一次（可配置fsync策略）系统fsync函数写入AOF文件



#### 优点

- 数据不丢失：后台线程1秒fsync一次
- 顺序读写：日志以追加模式写入文件，无磁盘随机读写
- 人类可读性强



#### 缺点

- AOF日志文件比RDB快照文件大
- AOF模式下Redis的写QPS比RDB模式低（因为一秒fsync一次）
- 较为复杂，容易有bug
- **数据恢复慢**



#### Rewrite机制

内存中的数据会被LRU淘汰，但AOF文件会不断增大，且会积压大量无效命令，当AOF文件到一定大小时，触发Rewrite操作

##### 操作过程

- fork子进程，此时Redis收到的请求都写到缓冲区中
- 清除AOF文件中已失效的操作
  - 同一个key的值，只保留最后一次写入
  - 去除已删除或者已过期数据相关命令

- 清除完通知主进程，将重写期间写进缓冲区的命令追加到子进程生成的文件
- 旧AOF文件替换新AOF文件，数据开始写入新AOF文件

##### 触发方式

- 执行bgrewriteaof命令
- 配置文件配置触发条件

https://www.jianshu.com/p/f72008c4d49f



#### AOF阻塞问题

Redis做fsync操作时，主线程会检查两次fsync的时间，如果距离上次fsync时间超过了2秒，那写请求就会阻塞

即everysec fsync一次，最多丢失2秒的数据，一旦fsync超过2秒的延时，整个Redis就被拖慢

可通过优化硬盘写入速度，用SSD解决







## RDB（默认启动）

#### 定义

每隔一定时间，将那个时刻的内存快照，以**二进制**数据的形式全量写进磁盘文件

而且每次都写进新文件，即每个文件都代表了某个时刻Redis中的完整数据



#### 优点

- 性能影响小：只需fork子进程来进行磁盘IO
- 恢复速度快：重启可用RDB文件来恢复数据（基于二进制数据）
- 适合做冷备份



#### 缺点

- **丢失数据**：由于是每隔一定时间才保存，所以宕机时相比AOP方式会丢失相对较多的数据

- 暂停服务：fork子进程生成文件时，若数据特别大，可能会导致暂停数毫秒 至 数秒 `为什么会？`

  所以RDB间隔时间不能太长，否则每次生成RDB文件过大，对性能有影响



#### 方式

有两种：手动触发和自动触发

- 手动触发

	- ```save```命令：阻塞主线程，必须等到RDB持久化完成之后，才会相应客户端的命令，所以**线上环境不建议使用**
	- ```bgsave```命令：Redis进程首先执行fork操作创建子进程，RDB持久化过程由子进程负责，完成后自动结束。阻塞只发生在fork阶段，一般时间很短，基本不会发生阻塞
	
- 自动触发

  - ```save m n```：表示m秒内有n个key修改时，自动触发`bgsave`命令

  - 在redis.conf配置文件配置

    ```shell
    save 900 1
    save 300 10
    save 60 10000
    ```

通过客户端shutdown安全退出Redis时也会立即生成一份完整的RDB快照



#### fork操作导致请求延时

fork子进程时，需要拷贝父进程的空间 [内存页表](https://zhuanlan.zhihu.com/p/37549063)，耗费一定时间

一般如果父进程内存有1G数据，fork可能耗费20ms；若10G - 30G，耗费几百ms

数据越大，fork子进程耗时越久

可以控制Redis内存在10G以内来控制延迟，也能降低主从全量复制的时间



**看下09数据备份的演练**