## 数据页与缓存页

MySQL对数据抽象为一个个的**数据页**，每个数据页包含若干行数据，默认大小16KB

更新数据时，BP会把那行数据所在的数据页load到BP中，即BP中存放的是一个个的数据页，称为**缓存页**

BP中的缓存页与磁盘中的数据页大小是一一对应的16KB



#### 缓存页描述信息

每个缓存页都有一些描述信息/数据（也叫控制信息/数据），例如数据页所属表空间、数据页编号，缓存页在BP中的地址等

BP中每个缓存页都会对应一个描述信息，在BP中会多使用一块空间来保存，称为**描述数据块**

BP中缓存页描述数据放最前面，各个缓存页放最后面



#### 描述信息大小

描述信息相当于缓存页大小的5%，大概800byte左右



![](.\pic\Buffer Pool结构.png)







## Buffer Pool

BP默认大小128MB



#### 空缓存页

DB把所有空闲缓存页对应的描述数据块组织为一个free双向链表

所以当DB启动时，所有缓存页的描述数据块都在free链表中



#### **非空缓存页**

DB会维护一个哈希表，用**表空间号**+**数据页号**作为key，非空缓存页的地址作为value

当要使用一个数据页的时，通过表空间号和数据页号作为key去哈希表查询，如果没有就读取数据页，如果有则说明数据页已经被缓存了。



#### 数据页装入缓存页流程

- 启动DB，根据BP参数指定的大小，到OS申请分配内存作为BP
- 按照缓存页和描述数据大小，在BP中划分出一个个的缓存页和对应的描述数据
- 执行crud操作时，到**哈希表**检查数据页是否已缓存，已缓存则直接读取缓存页
- 若数据页未缓存，则从free链表中获取一个描述数据块，找到对应的**空闲缓存页**
- 将磁盘中的数据页load进空闲缓存页，将描述数据块从free链表中移除（删除节点前后指针）







