#### 数据行

数据页每一行数据都有行格式，可在建表时指定，或者后续修改

每行除了每个字段的值以外，还包含很多额外信息

每行数据会连续的挤在一起

变长字段在行头倒序排长度

null值在行头倒序用bit指定是否为null

变长字段若为null，则不指定长度，加入null值行头的bit中，bit必须为8的倍数，高位补0

读取一行数据就是根据行头变长字段以及null值bit去识别数据的

每行会有40bit的数据头，描述这行数据

真实数据

每行的真实数据部分会加入一些隐藏字段

行溢出的任何类型字段用20字节的指针指向其他数据页，用链表连起来，称为溢出页



#### 数据页

文件头：38字节

数据页头：56字节

最大最小记录：26字节

数据行：不固定

空闲区域：不固定

数据页目录：不固定

文件尾部：8字节

缓存页和数据页一一对应，在磁盘上就是数据页，加载进BP就是缓存页

`数据页剩余空间放不下一个数据行是不是就产生碎片了？`



#### 表空间

表空间 = n组数据区

1组数据区 = 256数据区 = 256MB

1数据区(extent) = 64数据页 = 1MB

1数据页 = n数据行 = 16KB

extent组头结构见31

<img src=".\pic\表空间结构.png" style="zoom: 67%; float:left" />



数据页是固定大小的，所以在磁盘中有固定的起始和结束位置，刷盘时根据始末位置直接把老的数据页覆盖掉就行



#### MySQL读写机制原理

redolog、binlog顺序读写

表空间磁盘文件的数据页随机读写，性能差

IOPS：每秒执行磁盘读写操作次数

响应延迟：磁盘每次随机读写操作的响应延迟

因为数据库的每一次更新SQL语句，都必然涉及到多个磁盘随机读取数据页的操作，也会涉及到一条redo  log日志文件顺序写的操作。所以磁盘读写的IOPS指标，就是每秒可以执行多少个随机读写操作，以及每秒可以读写磁盘的数据量的吞吐量指标，就是每秒可以写入多少redo log日志，整体决定了数据库的并发能力和性能。

包括你磁盘日志文件的顺序读写的响应延迟，也决定了数据库的性能，因为你写redo log日志文件越快，那么你的SQL语句性能就越高。



#### Linux存储原理

##### IO调度优化

IO请求转换为Block IO请求之后，会把请求交个IO调度层，默认使用CFQ公平调度算法

如果一条sql需要执行很久，其他sql就只能等待

所以生产环境建议使用deadline IO算法，让任何IO线程不能一直不停的等待，当然也就不是顺序执行了



#### 底层硬件存储原理

##### 磁盘阵列

DB部署在服务器时，都是搭建RAID存储架构，就是一个磁盘冗余阵列，方便扩大磁盘存储空间

就是在服务器用多块磁盘存数据，使用RAID技术来管理这些磁盘

RAID有**数据冗余机制**，就是把你写入的数据同时写入两块磁盘，作为冗余备份，一块磁盘坏了可以从另一块磁盘读数据出来

##### RAID卡

写入磁盘阵列的数据，会先缓存在RAID卡的缓存中，后面再写入磁盘阵列，这种写缓冲机制，可以大幅度提升DB磁盘的写性能

RAID卡有独立的锂电池或者电容供电，一旦服务器宕机或断电，会把缓存中的数据写入磁盘阵列中

锂电池每个一段时间会充放电一次，以延长寿命和校准电池容量

充放电期间，IO就直接把数据写磁盘，不走RAID缓存，性能会退化10倍到毫秒级，所以DB每隔一段时间性能会出现几十倍的抖动



#### DB性能抖动

##### 解决方法

- 关闭RAID自动充放电，用脚本每隔一段时间自动在晚上凌晨的业务低峰时期，手动触发充放电，避免业务高峰期RAID自动充放电引起性能抖动

- 设置锂电池充放电时不要把缓存级别从write back修改为write through，可以和第二个策略配合使用



#### Too many connections故障

##### Linux资源限制

Linux默认会限制每个进程对机器资源的使用，尽量避免某个进程耗尽机器所有资源

包括可以打开的文件句柄限制、可以打开的子进程数限制、网络缓存限制、最大可锁定内存大小限制

所以Too many connections故障有可能是受Linux文件句柄限制，导致无法创建大量网络连接

即Linux把进程可以打开的文件句柄数限制为1024，尽管我们自定义了max_connections变量 `show variables like 'max_connections'`，但MySQL受Linux限制，无法创建那么多链接，根据某个计算公式算出来最大连接数只能是214

所以**生产环境部署时必须调整Linux内核参数，包括文件句柄数量限制**

查看系统对各进程资源限制：ulimit -a

- core file size：进程崩溃时转储文件大小限制
- max locked memory：最大锁定内存大小
- open files：最大可打开文件句柄数量
- max user processes：最多可以拥有的子进程数量

##### 解决方法

调整Linux最大文件句柄数限制 `ulimit -HSn 65535 `

限制数量根据实际情况调整，不是固定65535

可通过/etc/security/limits.conf & cat /etc/rc.local查看是否修改成功