- 数据页之间是双向链表
- 数据页中的数据行之间是单向链表



- 页目录：主键+槽位。槽对应的是一段数据行
- 全表扫描：一个个数据页加载进BP，然后一行行扫，扫完一页扫下一页，直到查找成功
- 主键查找：根据主键二分查找到槽位；非主键查找：全表扫描



- 索引要求后一个数据页的主键值都大于前一个数据页的主键值，

- 页分裂：保证下一个数据页里的主键值都比上一个数据页的主键值大

  当一页装不下了，弄第二页出来时，若主键是自己设置（非递增）且新增到第二页的记录的主键值小于前一页的主键值，mysql会有一个数据行的挪动过程，保证下一个数据页的主键值都大于上一个数据页的主键值



#### 主键索引

- 主键目录：把每个数据页的页号，还有数据页里最小的主键值放在一起，组成一个索引的目录

- 根据主键值到主键目录二分查找 `这里二分查找不太明白` 找到对应数据页，加载到BP中，再根据页目录对主键进行二分查找定位到某一行

- 索引和数据行一样，都是保存在页里面的

- 索引页：保存主键值和下层索引页的引用，将多个索引页组织为一棵B+树

  `插入数据时索引B+树的变化再理解下69`

- 最下层的索引页，有数据页的引用，且索引页之间相连，索引页跟数据页之间也相连

- 索引页和数据页共同组成B+树，如果这棵B+树的叶子结点就是数据页本身，那这棵B+树索引就是**聚簇索引**。若主键自增，会默认基于他做一个聚簇索引



#### 非主键索引

重新建一棵独立的B+树来保存数据，叶子结点也是数据页，但是数据页只保存了主键和索引字段数据，排序规则跟主键索引相同

找到后需要根据主键到聚簇索引进行回表查询完整的所有字段



#### 联合索引

重新建一棵独立的B+树来保存数据，每个数据页把联合索引所有字段的值和主键值作为一条记录，记录之间按所有字段的值来排序，且组织为单向链表，数据页之间组织为双向链表



#### 基本索引使用规则

现有一个联合索引（class, student, subject）

- 最左列匹配

  根据最左侧部分字段做等值查找

- 最左前缀匹配

  对最左列索引class列做LIKE 'abc%' 走索引，'LIKE '%abc' 不走索引

- 范围查找

  对最左列索引class列做大于、小于、between查询可以走索引

- 等值匹配 + 范围匹配

  对最左列索引class列等值查找，同时对student范围查找，可以走索引，若subject也范围查找，subject就不走索引



#### 排序使用索引

- 走索引

  按照联合索引的字段顺序进行order by，可直接利用B+树中的数据有序性排好序，然后获取数据的主键到聚簇索引进行回表查询获取剩余的字段

- 不走索引

  每个字段的排序规则必须相同，即都是ASC或DESC，否则不走索引

  order by中有非索引字段，也不走索引



#### 分组使用索引

与排序类似，最好是按照联合索引最左侧字段开始，按顺序排列来进行group by

`这里还是不理解`

`索引不适合建太多，会带来锁等待和死锁的问题，以及涉及到MySQL连接池、写redo log之类的问题，这块没搞懂`



#### 回表查询及覆盖索引

如果查询走联合索引，但是select的字段有不在联合索引中的，这时就需要从联合索引中取出数据，然后每条数据都会到聚簇索引中查找，降低性能，称为**回表查询**

若是select *，字段太多，MySQL甚至有可能不走联合索引，直接走聚簇索引全表扫描

所以当需要回表查询时，尽量用limit限制查询记录数，这样回聚簇索引查找时只会查找limit次，就还是会走联合索引的

**覆盖索引**是当select的字段跟联合索引一一符合，可以直接就从联合索引中取出数据，不需要回表查询

`1.blob和text类型可以加索引吗？2.为什么索引的长度一般设计为2的幂次方？特别是问题2我想了很久`



#### 索引设计原则

- 索引避免包含散列度低的字段
- 较长字符串类型的列，设计前缀索引，即包含前面部分字符到索引中去，这时where走索引，order by和group by不走

- where字段带函数的不走索引
- 主键尽量自增，保持有序，自然的新增数据页，不会导致频繁页分裂，较耗时

看到陌生人app一