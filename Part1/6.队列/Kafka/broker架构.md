## 消息设计

直接用Java类保存比较占空间，引用变量4字节，还要padding对齐

Kafka本质上使用Java NIO的ByteBuffer保存消息，是紧凑的二进制字节结构，无需padding对齐，省去很多空间，同时会使用文件系统的页缓存

进度：6.1.2开始



## 集群管理

Kafka通过zk实现分布式自动化服务发现与成员管理

每台broker启动时会将自己注册到zk下的一个节点与zk临时节点

-   broker生命周期

    zk的临时节点与客户端会话绑定，客户端会话失效，节点自动清除

    broker利用zk临时节点来管理生命周期，broker启动时会对应创建zk临时节点，同事创建监听器监听节点状态

    broker启动，监听器同步整个集群信息到该broker

    broker崩溃，与zk的会话失效，节点被删除，监听器处理broker崩溃的后续事宜



## 副本与ISR

每个分区的数据做多份副本（备份），将副本分摊到所有broker上，follower从leader请求数据并做出响应

ISR是topic分区维度的概念，每个topic分区都有自己的 ISR 列表，ISR本质是某个分区与leader**同步**的副本集合

leader副本在ISR中，ISR中的副本才可选为leader，ISR所有副本接受到才视为提交

- 位移信息

  起始位移、高水印值、日志末端位移

**对于一个参数的设置，有一点是很重要的：用户应该对他们知道的参数进行设置，而不是对他们需要进行猜测的参数进行设置。对于该参数来说，我们只能猜测应该设置成哪些值，而不是根据需要对其进行设置**  



#### ISR设计

同步/不同步的定义

P190 follower副本延迟检测新版本优化





P201 日志存储设计