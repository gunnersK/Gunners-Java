## 用户空间和内核空间

#### 内核空间（Kernel space）

是OS内核的运行空间（OS内核可简单理解为OS），OS本质也是比较底层的软件，本身运行也需要内存空间，所以OS使用的这块空间就叫内核空间

内核空间是内核代码运行的地方

进程运行在内核空间就处于内核态

内核空间可以执行任意命令，调用系统一切资源，比如磁盘写入操作、使用Socket通过网络往外发送数据（网卡也是系统资源）

#### 用户空间（User space）

Redis、Nginx等上层应用运行时用的内存就是用户空间

用户空间是用户程序代码运行的地方

进程运行在用户空间就处于用户态

用户空间只能执行简单运算，不能直接调用系统资源，必须通过系统调用接口（system call），才能向内核发出指令



> 在内存的使用上，如果上层应用运行时占据了OS的运行空间，就会导致OS运行出问题，所以为了安全，要隔离两个空间，即使用户程序崩溃了，内核也不受影响	







##  磁盘和内存间数据传输方式

#### PIO

早期使用PIO实现，读取磁盘文件到内存中，数据需要经过CPU存储转发，需要占用大量CPU时间来读取文件，导致访问文件时系统几乎停止响应

#### DMA（直接内存访问  Direct Memory Access）

不经过CPU，直接进行磁盘和内存（内核空间）的数据交换

CPU只需要向DMA控制器下达指令，让其处理数据传输，DMA通过系统总线来传输数据，传送完毕再通知CPU去内存取数据，很大程度降低CPU占有率，大大节省系统资源







## 缓存IO和直接IO

#### 缓存IO（Linux默认）

数据从磁盘先通过DMA复制到内核空间，内核空间起到一个缓冲作用，再从内核空间通过CPU复制到用户空间

优点：减少IO读写次数，一次系统调用，全部数据直接落盘

缺点：增加数据副本，耗时

#### 直接IO

数据直接从磁盘通过DMA复制到用户空间，**Mysql**使用直接IO，数据直接落盘，硬盘IO较多







## IO访问方式

#### 磁盘IO

当应用程序调用read接口时，OS先检查数据在不在内核的高速缓存，有就直接在缓存中返回，没有就从磁盘读取，然后保存在OS的缓存中

当应用程序调用write接口时，数据从用户空间复制到内核空间的缓存中，对应用程序来说，写操作已经完成，由OS决定何时将数据写入磁盘，除非显式调用sync同步命令

#### 网络IO

- 当调用read系统调用时，通过DMA将数据复制到内核
- 然后由CPU控制将内核数据复制到用户空间下的buffer中
- read调用完成后，write调用首先将用户空间buffer中的数据复制到内核空间下的socket buffer中
- 最后通过DMA复制将内核空间下的socket buffer中的数据复制到网卡中传输

#### 磁盘IO与网络IO对比

- 磁盘IO主要由转动、寻址、块传输延时决定
- 网络IO主要由服务器响应延时、带宽限制、网络延时、跳转路由延时、本地接收延时决定，收环境干扰极大

所以能磁盘IO就不要网络IO



0124