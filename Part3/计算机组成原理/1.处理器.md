## CPU Cache

#### Cache结构

每个CPU核心独有L1 & L2两级缓存，共享L3三级缓存，通过总线与主内存交互

图：



#### Cache Line

Cache Line是Cache与主内存交换的最小单位

每个Line由以下部分组成：

- Valid：当前Line是否有效
- Tag：对应内存地址
- Block：缓存数据

Cache Line会和主内存映射起来 `映射这里还没搞明白`



#### 写Cache

分为直写和回写

##### 直写

通过本级缓存直接把数据写到下一级缓存，或直接写主内存

其他核心立即都会接到通知，去获取最新的Line



##### 回写

只修改本级缓存的数据，将缓存Line标为dirty

需要等待触发dirty Line回写到下一级缓存或主内存，这时dirty Line就变clean

丢弃一个dirty Line总是会触发一次回写



#### 一致性协议

这种多级Cache的模式，在多核心、回写的模式下会出现数据不一致的问题

这就引出了一致性协议

- 归纳CPU在MESI协议作用下读写变量时变量状态的演变过程
- 是通过缓存不停地窥探总线来实现的
- MESI是否不对所有变量起作用，只用于volatile之类的变量，维护其一致性？



#### 伪共享