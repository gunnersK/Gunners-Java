## 功能概述

- 为网络层提供服务

  无确认无连接 -- 包发出去就不管了

  有确认无连接 -- 发包后需接收确认包，不建立连接

  有确认有连接 -- 建立连接发包接收确认包，最可靠

- 链路管理

  管理连接的建立、维持、释放，用于面向连接的服务

- 组帧
- 流量控制
- 差错控制（帧错/位错）









## 封装帧

#### 定义

在数据的前后添加包含**控制信息**首部和尾部，用来做帧定界，确定帧的界限

<img src=".\pic\封装帧.jpg" style="zoom:80%; float:left" />



#### 组帧方法

- 字符计数

- 字符（节）填充

  填充字符/字节表示帧边界，用于传输文本文件（ASCII码）

  传输非文本文件时，需要转义字符来区分帧边界字符/字节与真实数据，较麻烦

- 零比特填充（常用）

  发送端：扫描帧，在n个1后填1个0

  接收端：反之，先找到帧边界字段，然后n个1后删1个0，如此便不会引起帧边界判断错误

- 违规编码（常用）









## 差错控制

差错是由噪声引起的



#### 差错类型

- 帧错
- 位/比特错 -- 进行差错控制



#### 检错编码

只能检测到帧错误，不能具体到哪一位错误

- 奇偶校验码

  在信息元前面加1为检验元 “1”，使得整个帧 “1”的个数为奇或偶数，以此判断帧是否出错

- 循环冗余码CRC

  可以实现无差错传输，即接收到的都是正确的，丢弃错误的，但不能做到可靠传输，可靠传输是发送端发送什么，接收端就接收到什么



#### 纠错编码

- 海明码 -- 可以检测到具体哪位错



物理层编码针对**单个**比特，解决传输中比特同步问题

数据链路层编码针对**一组**比特，通过冗余码技术实现一组比特在传输中是否出错









## 流量控制与可靠传输协议

#### 流量控制

较高发送速度和较低接受能力不匹配，导致传输出错

数据链路层的流量控制是点对点，传输层是端到端

- 停止 - 等待协议（特殊的滑动窗口）

  发送完一个帧就停止，等待对方确认，收到确认后再发下一个帧

- 滑动窗口协议

  - 选择重传协议（GBN）
  - 后退N帧协议（SR）

  接收端不回复确认，发送端的窗口就不往前移卡在原地，最多也只能发窗口范围内的数据，实现流量控制



#### 停止 - 等待协议

发送一帧，启动定时器，到期前接收确认帧，再发送下一帧

解决流量控制、可靠传输

<img src=".\pic\停止等待协议.jpg" style="zoom:80%; float:left" />

- 帧丢失&帧出错

  若帧丢失或出错，接收端未能在定时器到期前发送ACK确认帧，发送端超时未收到ACK后重传该帧，所以发送完一个帧后要保留副本，以备超时重传

- ACK丢失

  接收端成功接收后发送ACK丢失，发送端超时未收到ACK后重传该帧，接收端再次接收到该帧后直接丢弃，并重传该帧的ACK

- ACK超时

  前面与ACK丢失一致，发送到接收到超时的ACK之后，直接丢弃



#### 后退N帧协议（GBN）

<img src=".\pic\后退N帧协议.jpg" style="zoom:80%; float:left" />

##### 发送方

- 上层调用 -- 上层发送数据时，发送方先检查是否有空闲的发送窗口，有则用一个窗口发送；没有将数据返回上层，让上层等会再发，也可以将数据缓存起来，等有空闲窗口再发

- ACK接收 -- GBN协议中，对n号帧采用**累积确认**方式，表示接收方已收到n号帧及之前的全部帧
- ACK接收超时 -- 发送方**后退N帧**，重传所有已发送但未收到ACK确认的帧，即则把某帧（含）之后的帧全部重发一遍

##### 接收方

只按顺序接收帧，乱序全部丢弃

- 接收窗口为1
- 按顺序正确收到n号帧，则发送该帧ACK，并将帧的数据部分交给上层
- 无需缓存任何失序帧，只需维护下一个按序接收的帧序号，如果收到顺序跳跃的帧，返回已接收的**最大序号**的帧ACK

##### 滑动窗口长度

用n个比特对帧编号，则窗口大小满足：(2 ^ n) - 1

窗口长度不可以无限大，因为帧编号是循环使用，如果窗口长度超过编号范围，接收方无法区分新旧帧

##### 优缺点

- 优点 -- 连续发送帧，提高信道利用率
- 缺点 -- 重传时须重传已正确传送的帧，传送效率低。使用选择重传协议优化