无论是硬盘、内存还是cpu，读取数据都是按块读取，读取一个数据会顺便读取它相邻的数据。硬盘读硬盘块，内存读内存页，cpu读缓存行

cpu以缓存行读取数据(按块读取思想)，intel缓存行容量64，两个核同时读取缓存行，一个修改数据会立即通知另一个核需要刷新缓存行最新的数据，这就是缓存一致性协议(MESI)。如果两个核同时修改同一个缓存行不同的数据，就会发生伪共享

OS程序安装在硬盘第一块扇区上，开机时，硬件程序是写死到硬盘第一个块扇区引导OS启动的

OS启动完所有硬件操作权就归OS关了

《Linux内核设计与实现》

内核是OS管理硬件的程序

宏内核与微内核（鸿蒙OS物联网）

<img src=".\pic\内核管理模型.png" style="zoom:80%; float: left"/>

#### 用户态与内核态

cpu 不同级别的指令

Linux内核跑在ring0级，用户程序跑在ring3级

内核有200多个函数来进行系统调用：read、write....

#### 进程 线程 纤程 中断

进程是OS**分配资源**的基本单位，最重要的资源是内存空间

线程是OS**执行调度**的基本单位，线程共享进程的内存空间，没有自己独立的内存空间

JVM里的线程和OS的线程是一一对应的，JVM起一个线程，OS就会起一个对应的线程，是重量级线程，在内核空间，起不了多少个

纤程是用户空间级的线程，线程中的线程，可以起很多个，JVM自己管理和切换，不需经过OS

纤程优势：
1.占有资源少 OS起线程要用1M，线程只要4k
2.纤程切换简单
3.可以启动很多个（10w+）

纤程应用场景：很短的计算任务，不需要和内核打交道，并发量高

#### cpu如何区分一个立即数 和 一条指令？

cpu和内存之间有三条总线相连：数据总线、地址总线、控制总线，从哪条总线过来的cpu就认为是啥

#### 进程

Linux也称为task，是系统分配资源的基本单位，进程 描述符：PCB（Process Control Block）

- 僵尸进程：父进程产生子进程后，会维护子进程的一个PCB结构，子进程退出，由父进程释放。若父进程没有释放，子进程成为一个僵尸进程
- 孤儿进程：子进程结束之前，父进程已经退出，孤儿进程会成为init进程的孩子，即换了个爹，由1号进程维护

#### 进程调度

要学会最大限度压榨CPU资源

按优先级分配时间片的比例，记录每个进程的执行时间，如果有一个进程执行时间达不到他应该分配的比例，则优先执行

进程类型：

- IO密集型，大部分时间用于等待IO，时间片分配少

- CPU密集型，大部分时间用于CPU计算，时间片分配多







## 内存管理

老OS多个进程装入内存，引发两个问题：内存不够用、互相打扰

现代OS的内存管理系统：虚拟地址、分页装入、软硬件结合寻址

#### 内存分页（解决内存不够用）

- 分页：内存分为固定大小的页框（最基本大小都是4k），硬盘上的程序也分成4k的块，用到哪块，加载哪块

- 内存淘汰（LRU - Least Recently Used）：当内存要给程序分配空间时，若内存已满，会把最不常用的一块放进swap（Linux的交换分区，位于硬盘），加载最新一块进来

- 内存淘汰算法（LRU - Least Recently Used）：hash表（保证查找O(1)）+ 双向链表（保证排序和新增O(1) 、前后相连）

  用到哪块内存就把他挪到最后面，保证头结点是最不常用的内存，需要时直接淘汰头结点内存

<img src=".\pic\LRU算法结构.png" style="zoom:80%; float: left"/>

#### 虚拟内存（解决互相打扰）

- 虚拟空间大小 = 寻址空间 = 2 ^ 系统位数，比物理空间大很多bit
- 站在进程的角度，自己独占一块虚拟空间，会被MMU映射到物理地址，确保安全







## 操作系统

#### OS功能和目标

作为用户和硬件之间的接口

- 命令接口：联机命令、脱机命令

- 程序接口：系统调用（用户通过程序间接使用）

- GUI：图形界面接口



#### OS的特征

- 并发

  指多个事件在同一时间间隔内发生。宏观上同时发生，微观上交替发生

  **区分并行**：并行指多个时间同一时刻发生

- 共享

  系统资源供内存多个并发执行的进程共同使用  

  互斥共享（共享摄像头）

  同时共享（共享硬盘资源）

- 虚拟

  空分复用技术（如虚拟存储）

  时分复用技术（如虚拟处理器）

- 异步

  

#### 操作系统运行机制与指令

特权指令 -> 内核态 -> 内核程序

非特权指令 -> 用户态/内核态 ->用户程序/内核程序

CPU用程序状态寄存器（PSW）某个标志位标识：0用户态，1内核态

##### 内核结构

- 时钟管理：实现计时功能

- 中断处理：实现中断机制

- 原语

  是一种特殊的程序，处于OS最底层，最接近硬件

  运行具有原子性，时间较短，调用频繁

- 系统资源管理

  进程管理、存储器管理、设备管理

<img src=".\pic\内核结构.png" style="zoom: 80%; float:left" />

##### 大内核与小内核

大内核：主要模块都在内核中，性能高，结构混乱难维护。类比小公司管理层

微内核：只保留最基本的功能在内核，性能低，需要频繁切换内核态与用户态，方便维护。类比大公司管理层