## 需要性能调优的地方

#### 硬件优化

- 上线前 -- 做硬件选型
- 上线后 -- 做硬件扩展



#### 操作系统优化

- OS安装优化
- 进程管理调优
- 内存资源调优
- IO调度调优
- 文件系统调优
- 网络传输调优



#### 应用程序优化

大多数是从代码层面进行优化









## 系统调优的时机

- 上线前 -- 做基础调优
- 上线后 -- 不可盲目优化，有用户反馈系统性能差再去做针对性优化









## 如何进行性能调优

#### 确定性能指标

- 吞吐量/并发量 -- 单位时间内系统能处理的请求数量
- QPS -- 每秒处理请求数
- TPS -- 每秒处理事务数
- RT -- 响应时间（平均），客户端发出请求到接受响应的时间，由请求发送时间+网络传输时间+服务器处理时间组成

性能指标间的关系：QPS * RT = 并发量



#### 收集性能相关数据

- 服务器信息 -- 硬件配置、系统版本、各资源使用情况
- 服务器日志 -- 系统日志，如dmesg、/var/log/message等
- 应用程序资源占用情况、日志



#### 找出性能瓶颈

检验性能瓶颈的工具：

- CPU瓶颈 -- vmstat、htop、iostat
- 内存瓶颈 -- free、vmstat、smem
- 磁盘IO瓶颈 -- iostat、iotop
- 网络瓶颈 -- netstat、mtr、traceroute



#### 性能调优过程

调优前确定调优目标，比如性能提升多少百分比

调优就是维持系统资源使用平衡

需要遵循以下原则：

- 不要随意改动不熟悉的系统参数
- 控制变量，每次只调试一种系统资源，或一个参数配置
- 性能达标时就不要随意改动，并做好监控
- 使用多个工具测试分析一项系统资源，得到更加客观的结果，只用一个工具代表性较低



#### 验证调优效果

通过性能监控，来验证性能调优效果，包括服务器性能监控和服务性能监控，必要的指标如下：

- CPU负载、使用率（系统进程）
- 内存使用率
- 磁盘IO
- 网络流量
- 磁盘空间占用









## CPU瓶颈及优化

#### CPU性能瓶颈

- 应用程序bug耗尽CPU

- CPU本身资源不足

  一些应用程序会针对CPU做优化，比如绑定到指定CPU核心运行，避免了CPU cache刷新



#### CPU性能优化方法

- 结束CPU消耗大的无佣金差
- 尝试将进程or线程绑定到某个CPU上，避免CPU切换，引起cache刷新
- 应用程序尽量使用并行计算，充分利用CPU资源

拉钩1-5 1739 内存瓶颈优化