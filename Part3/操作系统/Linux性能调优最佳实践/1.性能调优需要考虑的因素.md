## 需要性能调优的地方

#### 硬件优化

- 上线前 -- 做硬件选型
- 上线后 -- 做硬件扩展



#### 操作系统优化

- OS安装优化
- 进程管理调优
- 内存资源调优
- IO调度调优
- 文件系统调优
- 网络传输调优



#### 应用程序优化

大多数是从代码层面进行优化









## 系统调优的时机

- 上线前 -- 做基础调优
- 上线后 -- 不可盲目优化，有用户反馈系统性能差再去做针对性优化









## 如何进行性能调优

#### 确定性能指标

- 吞吐量/并发量 -- 单位时间内系统能处理的请求数量
- QPS -- 每秒处理请求数
- TPS -- 每秒处理事务数
- RT -- 响应时间（平均），客户端发出请求到接受响应的时间，由请求发送时间+网络传输时间+服务器处理时间组成

性能指标间的关系：QPS * RT = 并发量



#### 收集性能相关数据

- 服务器信息 -- 硬件配置、系统版本、各资源使用情况
- 服务器日志 -- 系统日志，如dmesg、/var/log/message等
- 应用程序资源占用情况、日志



#### 找出性能瓶颈

检验性能瓶颈的工具：

- CPU瓶颈 -- vmstat、htop、iostat
- 内存瓶颈 -- free、vmstat、smem
- 磁盘IO瓶颈 -- iostat、iotop
- 网络瓶颈 -- netstat、mtr、traceroute



#### 性能调优过程

调优前确定调优目标，比如性能提升多少百分比

调优就是维持系统资源使用平衡

需要遵循以下原则：

- 不要随意改动不熟悉的系统参数
- 控制变量，每次只调试一种系统资源，或一个参数配置
- 性能达标时就不要随意改动，并做好监控
- 使用多个工具测试分析一项系统资源，得到更加客观的结果，只用一个工具代表性较低



#### 验证调优效果

通过性能监控，来验证性能调优效果，包括服务器性能监控和服务性能监控，必要的指标如下：

- CPU负载、使用率（系统进程）
- 内存使用率
- 磁盘IO
- 网络流量
- 磁盘空间占用









## CPU瓶颈及优化

#### CPU性能瓶颈

如果CPU持续满负荷，同时应用程序运行缓慢甚至无响应，重启应用后CPU又马上打满，此时基本能判断CPU出现瓶颈

常见的CPU瓶颈有两种原因：

- 应用程序bug耗尽CPU

- CPU本身资源不足

  一些应用程序会针对CPU做优化，比如绑定到指定CPU核心运行，避免了CPU cache刷新



#### CPU性能优化方法

- 结束CPU消耗大的无用进程
- 尝试将进程or线程绑定到某个CPU上，避免CPU切换，引起cache刷新
- 应用程序尽量使用并行计算，充分利用CPU资源









## 内存瓶颈及优化

#### 内存性能瓶颈

不可看到空闲内存很少就直接判断内存不足，要通过free、top、smem等工具获取内存指标，如果发现内存持续减少，系统kswapd进程频繁出现，同时swap交换空间占用率持续增高，则基本可以判定内存资源不足

常见的内存瓶颈有两种原因：

- 应用程序bug
- 本身内存不足



#### 内存性能优化方法

- 关闭OS上用不到的服务，腾出内存
- 调整swap使用机制与page-out使用率，尽量使用物理内存，不用swap交换空间
- 使用bigpages、hugetlb和共享内存调优
- 调整页大小，优化OS虚拟内存参数（/proc/sysy/vm）









## 磁盘瓶颈及优化

#### 磁盘性能瓶颈

- 通过磁盘IO监控命令如iostat、iotop等，发现%iowait持续超过80%，**且CPU的IO等待非常高**
- 应用读写操作响应时间很长，或在网络正常的情况下有非常低的网络利用率
- 磁盘请求队列（/sys/block/sda/queue/nr_requests）满了，处理请求时间变长



#### 磁盘性能优化方法

- 磁盘分区不要划分过大，考虑使用Linux逻辑卷分区 `不大懂`
- 使用RAID，在RAID阵列中添加更多磁盘，把数据分散到多块物理磁盘，可以同时增加度和性能
- 增加更多磁盘提升IO性能
- 增加物理内存，可以提升磁盘缓冲，增强磁盘响应速度
- 修改磁盘的默认请求队列数，可以大幅提升磁盘吞吐量（但是要牺牲一定的内存）









## 网络瓶颈及优化

#### 网络性能瓶颈

服务器CPU、内存、磁盘IO都正常，但连接服务器变慢、服务器响应变慢、连接请求超时、业务系统访问缓慢、网络传输带宽上不去等



#### 网络性能优化方法

- 确保网卡带宽和交换机配置相匹配（比如不能千兆网卡连接在百兆网口交换机上）`不懂`
- 网卡带宽不足时，可通过绑定双网卡提高吞吐量，或者用光纤网络解决
- 适当调整IPv4的TCP内核参数（/proc/sys/net），可一定程度提升网络性能