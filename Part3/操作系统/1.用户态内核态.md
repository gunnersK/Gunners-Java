## 操作系统运行机制与指令

特权指令 -> 内核态 -> 内核程序

非特权指令 -> 用户态/内核态 ->用户程序/内核程序

CPU用程序状态寄存器（PSW）某个标志位标识当前处于：0用户态，1内核态

#### 内核结构

- 时钟管理：实现计时功能

- 中断处理：实现中断机制

- 原语

  是一种特殊的程序，处于OS最底层，最接近硬件

  运行具有原子性，时间较短，调用频繁

- 系统资源管理

  进程管理、存储器管理、设备管理

#### 大内核与小内核

大内核：主要模块都在内核中，性能高，结构混乱难维护。类比小公司管理层

微内核：只保留最基本的功能在内核，性能低，需要频繁切换内核态与用户态，方便维护。类比大公司管理层







## 进程的用户态和内核态

当一个任务（进程）执行系统调用而陷入内核代码中执行时，就称进程处于内核运行态，执行的内核代码会使用当前进程的**内核栈**

当进程在执行用户自己的代码时，则称其处于用户运行态。即此时处理器在特权级最低的（3级）用户代码中运行

特权级指令：用户态下和内核态下工作的程序有很多差别，但最重要的差别就在于特权级的不同，即权力的不同。运行在用户态下的程序不能直接访问操作系统内核数据结构和程序，不能执行最高特权级指令，即调用系统物理资源



#### 用户态切换内核态的方式

只能通过中断来使用户态切换到内核态，比如发生了系统调用，或者程序发生异常

- 系统调用 -- 用户态进程主动行为
- 异常 -- CPU执行用户态程序时发生异常，如算术异常或缺页异常，会切换到内核态

